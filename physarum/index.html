<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Physarum</title>
  <!-- MOBILE––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- CSS––––––––––––––––––––––– -->
  <link rel="stylesheet" href="../shared/css/normalize.css">
  <link rel="stylesheet" href="../shared/css/skeleton.css">
  <link rel="stylesheet" href="../shared/css/darkskelleton.css" media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="../shared/css/style.css">
  <link rel="icon" type="image/png" href="/images/favicon.png">
</head>

<body>
  <style>
    .container {
      max-width: 1024px;
      /* override default width so canvas doesn't get scaled*/
    }
  </style>
  <div class="container" style="margin-top: 1em;">
    <a href="../">Back to Overview</a>
    <div class="row">
      <div class="column">
        <h1>Physarum</h1>
        <p>
          Physarum is a cool slime mould.
        </p>
      </div>
    </div>

    <div class="row">
      <p id="webglWarning" style="display: none;">
        <b style="color: red;">Due to WebGL issues, the simulation might not work well on your device</b>
      </p>
      <canvas width="1024" height="1024" class="u-full-width" id="canvas"></canvas>
    </div>
  </div>

  <!-- Minimal Vertex Shader -->
  <script id="vs" type="x-shader/x-vertex">
    attribute vec4 a_position;
    
    void main() {
      gl_Position = a_position;
    }
  </script>


  <!-- Texture Render Shader -->
  <script type="x-shader/x-fragment" id="textureRenderShader">
    precision mediump float;
    
    uniform vec2 u_simResolution;
    uniform vec2 u_resolution;
    uniform sampler2D u_simTexture;
      
    void main() {
     gl_FragColor = texture2D(u_simTexture, gl_FragCoord.xy/u_resolution);
    }
  </script>

  <!-- Point Sprite Vertex Shader -->
  <script id="vs_points" type="x-shader/x-vertex">
    precision mediump float;

    attribute vec2 a_Index; // UV index of the sprite
    uniform vec2 u_simResolution;
    uniform vec2 u_resolution; // width/height of screen
    uniform sampler2D u_simTexture;
    uniform sampler2D u_pheroTexture;

    void main() {
      vec4 simData = texture2D(u_simTexture, 2.*a_Index/u_simResolution-1.);
      vec2 pos = simData.xy;
      gl_Position = vec4(pos, 0.0, 1.0);
      gl_PointSize =1.0;
    }
  </script>

  <!-- Final Render Shader -->
  <script type="x-shader/x-fragment" id="renderShader">
    precision mediump float;
    
    uniform vec2 u_simResolution;
    uniform vec2 u_resolution;
    uniform sampler2D u_simTexture;
    uniform sampler2D u_pheroTexture;
      
    void main() {
      vec4 simData = texture2D(u_pheroTexture, gl_FragCoord.xy/u_resolution);
  
     gl_FragColor = vec4(simData.rgb, 1.);
     //gl_FragColor = vec4(1.,0.,0.,1.);
    }
  </script>

  <!-- inital particle attributes Shader -->
  <script type="x-shader/x-fragment" id="initShader">
    precision mediump float;
    #define M_PI 3.141592653589793
    
    uniform vec2 u_simResolution;
    uniform vec2 u_resolution;
      
    vec2 n2rand(vec2 uv) {
      return vec2(fract(sin(dot(uv.xy, vec2(12.9898, 78.233))) * 43758.5453),
        fract(sin(dot(uv.xy * 1.61803, vec2(12.9898, 78.233))) * 43758.5453));
    }

    void main() {
      vec2 uv =2.* gl_FragCoord.xy/u_resolution -1.;
      gl_FragColor = vec4(uv, uv.x*2.*M_PI, 1.);
    }
  </script>

  <!-- update positions and velocities Shader -->
  <script type="x-shader/x-fragment" id="simShader">
    precision mediump float;

    #define M_PI 3.141592653589793

    uniform float u_speed;
    uniform float u_time;
    uniform float u_searchAngle;
    uniform float u_searchDistance;
    uniform float u_rotationRate;
    uniform vec2 u_simResolution;
    uniform vec2 u_resolution;
    uniform sampler2D u_simTexture;
    uniform sampler2D u_pheroTexture;
    uniform float u_dt;
  
    uniform float D_a, D_b, f, k;

    float getPheroAtAngle(float a, float dir){
      vec2 offset = u_searchDistance * vec2(cos(dir+a), sin(dir+a));
      return texture2D(u_pheroTexture, (offset+gl_FragCoord.xy)/u_resolution).a;
    }
    
    void main() {
      vec4 simData = texture2D(u_simTexture, gl_FragCoord.xy/u_simResolution);
      vec2 pos = simData.xy;
      float dir = simData.z; 

      float pheroL = getPheroAtAngle(-u_searchAngle,dir);
      float pheroC = getPheroAtAngle(0.,dir);
      float pheroR = getPheroAtAngle(u_searchAngle,dir);
      
    //if (pos.x>1. || pos.x<-1. || pos.y>1. || pos.y<-1.) {
      if (pos.x*pos.x+pos.y*pos.y>1.) {
        float centerDir = atan(-pos.y, -pos.x);
        float delta = mod(centerDir - dir + 3.*M_PI, 2.*M_PI) - M_PI;
        if(delta > 0.){
          dir += u_rotationRate *u_dt;
        }else{
          dir -= u_rotationRate *u_dt;
        }
      }else{
        //main code
        if(pheroL < pheroR-.05){
          dir -= u_rotationRate *u_dt;
        } 
        if(pheroL-.05 > pheroR){
          dir += u_rotationRate *u_dt;
        }
      }
      vec2 vel = vec2(cos(dir), sin(dir)) * u_speed;

      gl_FragColor = vec4(pos + vel*u_dt, dir, simData.w);
    }
  </script>

  <script type="text/javascript" src="../shared/twgl.min.js"></script>
  <script type="text/javascript" src="script.js"></script>
</body>
<script>var cfla = document.createElement('script'); cfla.defer = true; cfla.src = 'https://static.cloudflareinsights.com/beacon.min.js'; cfla.setAttribute("data-cf-beacon", '{"token": "f9f51233f11041a194c4d5f4511d8282"}'); if (!localStorage.getItem("devmode")) document.body.appendChild(cfla)</script>

</html>